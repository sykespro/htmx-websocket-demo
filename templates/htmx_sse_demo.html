<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE Demo - Real-time Server-Sent Events</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen" x-data="sseApp()">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-primary-500 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-semibold text-gray-900">SSE Demo</h1>
                    <div class="flex items-center space-x-2">
                        <a href="/" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors">
                            Chat Demo
                        </a>
                        <a href="/data-stream" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors">
                            Data Stream Demo
                        </a>
                    </div>
                </div>
                
                <!-- Connection Status and Controls -->
                <div class="flex items-center space-x-4">
                    <!-- Connection Status -->
                    <div class="flex items-center space-x-2" 
                         :class="connectionStatus === 'connected' ? 'text-green-600' : connectionStatus === 'connecting' ? 'text-yellow-600' : 'text-red-600'">
                        <div class="w-2 h-2 rounded-full" 
                             :class="connectionStatus === 'connected' ? 'bg-green-500' : connectionStatus === 'connecting' ? 'bg-yellow-500 animate-pulse' : 'bg-red-500'"
                             x-transition></div>
                        <span class="text-sm font-medium" x-text="connectionStatusText"></span>
                    </div>
                    
                    <!-- Controls -->
                    <div class="flex items-center space-x-2">
                        <button @click="startConnection()" 
                                :disabled="connectionStatus === 'connected' || connectionStatus === 'connecting'"
                                class="px-3 py-1 text-sm rounded-lg transition-colors"
                                :class="connectionStatus === 'connected' || connectionStatus === 'connecting' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-green-100 text-green-700 hover:bg-green-200'">
                            Start
                        </button>
                        <button @click="stopConnection()" 
                                :disabled="connectionStatus === 'disconnected'"
                                class="px-3 py-1 text-sm rounded-lg transition-colors"
                                :class="connectionStatus === 'disconnected' ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-red-100 text-red-700 hover:bg-red-200'">
                            Stop
                        </button>
                        <button @click="clearFeed()" 
                                class="px-3 py-1 text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors">
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Events</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.totalEvents"></p>
                    </div>
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Connection Time</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="connectionTime"></p>
                    </div>
                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Events/min</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.eventsPerMinute.toFixed(1)"></p>
                    </div>
                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Last Event</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="stats.lastEventTime"></p>
                    </div>
                    <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Data Feed -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">Live SSE Data Feed</h2>
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <div class="w-2 h-2 bg-primary-500 rounded-full" 
                             x-show="connectionStatus === 'connected'" 
                             x-transition></div>
                        <span x-text="connectionStatus === 'connected' ? 'Live' : 'Stopped'"></span>
                    </div>
                </div>
            </div>
            
            <!-- SSE Connection Container -->
            <div class="h-96 overflow-y-auto p-4 bg-gray-50" 
                 id="sse-feed"
                 hx-ext="sse"
                 x-show="connectionStatus === 'connected'"
                 sse-connect="/sse-stream"
                 sse-swap="message"
                 hx-swap="beforeend">
                
                <!-- Data will be inserted here by HTMX SSE -->
            </div>
            
            <!-- Welcome/Instructions when disconnected -->
            <div class="h-96 flex items-center justify-center bg-gray-50" 
                 x-show="connectionStatus !== 'connected'" 
                 x-transition>
                <div class="text-center py-8">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2" x-text="connectionStatus === 'connecting' ? 'Connecting to SSE Stream...' : 'Ready to Connect'"></h3>
                    <p class="text-gray-500 max-w-sm" x-text="connectionStatus === 'connecting' ? 'Establishing Server-Sent Events connection...' : 'Click Start to begin receiving real-time data via Server-Sent Events. Data will appear here as it streams from the server.'"></p>
                </div>
            </div>
        </div>

        <!-- Instructions Card -->
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4" x-show="connectionStatus === 'disconnected'" x-transition>
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5 text-blue-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-blue-800 mb-1">Server-Sent Events Demo</h3>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• Click "Start" to establish an SSE connection to the server</li>
                        <li>• Watch real-time sensor data stream automatically via SSE</li>
                        <li>• HTMX SSE extension handles DOM updates without JavaScript</li>
                        <li>• Data includes temperature, humidity, and pressure readings</li>
                        <li>• SSE provides unidirectional server-to-client communication</li>
                        <li>• Automatic reconnection on connection loss (browser feature)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Technical Info Card -->
        <div class="mt-6 bg-green-50 border border-green-200 rounded-lg p-4" x-show="connectionStatus === 'connected'" x-transition>
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-green-800 mb-1">SSE Connection Active</h3>
                    <ul class="text-sm text-green-700 space-y-1">
                        <li>• Server-Sent Events connection established successfully</li>
                        <li>• HTMX is automatically handling incoming events and DOM updates</li>
                        <li>• Each event is formatted as HTML and inserted into the feed</li>
                        <li>• Connection uses standard HTTP with text/event-stream content type</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <script>
        function sseApp() {
            return {
                connectionStatus: 'disconnected', // 'disconnected', 'connecting', 'connected'
                connectionStartTime: null,
                stats: {
                    totalEvents: 0,
                    eventsPerMinute: 0,
                    lastEventTime: '--:--'
                },
                
                get connectionStatusText() {
                    switch (this.connectionStatus) {
                        case 'connecting': return 'Connecting...';
                        case 'connected': return 'Connected';
                        default: return 'Disconnected';
                    }
                },
                
                get connectionTime() {
                    if (!this.connectionStartTime || this.connectionStatus !== 'connected') {
                        return '00:00';
                    }
                    
                    const elapsed = Math.floor((Date.now() - this.connectionStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                },
                
                init() {
                    // Set up HTMX SSE event listeners
                    this.setupSSEListeners();
                    
                    // Update connection time every second
                    setInterval(() => {
                        // Trigger reactivity for connectionTime
                        this.$nextTick();
                    }, 1000);
                },
                
                setupSSEListeners() {
                    // Listen for SSE connection events
                    document.body.addEventListener('htmx:sseOpen', (event) => {
                        console.log('SSE connection opened');
                        this.connectionStatus = 'connected';
                        this.connectionStartTime = Date.now();
                    });
                    
                    document.body.addEventListener('htmx:sseError', (event) => {
                        console.log('SSE connection error:', event.detail);
                        this.connectionStatus = 'disconnected';
                        this.connectionStartTime = null;
                    });
                    
                    document.body.addEventListener('htmx:sseClose', (event) => {
                        console.log('SSE connection closed');
                        this.connectionStatus = 'disconnected';
                        this.connectionStartTime = null;
                    });
                    
                    // Listen for new messages to update stats
                    document.body.addEventListener('htmx:afterSwap', (event) => {
                        if (event.target.id === 'sse-feed') {
                            this.updateStats();
                            this.limitFeedItems();
                        }
                    });
                },
                
                startConnection() {
                    this.connectionStatus = 'connecting';
                    
                    // Trigger HTMX SSE connection
                    const feedElement = document.getElementById('sse-feed');
                    if (feedElement) {
                        // Clear any existing connection
                        htmx.trigger(feedElement, 'htmx:sseClose');
                        
                        // Start new connection
                        htmx.process(feedElement);
                    }
                },
                
                stopConnection() {
                    this.connectionStatus = 'disconnected';
                    this.connectionStartTime = null;
                    
                    // Close HTMX SSE connection
                    const feedElement = document.getElementById('sse-feed');
                    if (feedElement) {
                        htmx.trigger(feedElement, 'htmx:sseClose');
                    }
                },
                
                clearFeed() {
                    const feedElement = document.getElementById('sse-feed');
                    if (feedElement) {
                        feedElement.innerHTML = '';
                    }
                    
                    // Reset stats
                    this.stats = {
                        totalEvents: 0,
                        eventsPerMinute: 0,
                        lastEventTime: '--:--'
                    };
                },
                
                updateStats() {
                    this.stats.totalEvents++;
                    this.stats.lastEventTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    // Calculate events per minute
                    if (this.connectionStartTime) {
                        const elapsedMinutes = (Date.now() - this.connectionStartTime) / (1000 * 60);
                        this.stats.eventsPerMinute = this.stats.totalEvents / elapsedMinutes;
                    }
                },
                
                limitFeedItems() {
                    const feedElement = document.getElementById('sse-feed');
                    if (feedElement) {
                        const items = feedElement.querySelectorAll('.data-item');
                        // Keep only last 50 items
                        if (items.length > 50) {
                            for (let i = 0; i < items.length - 50; i++) {
                                items[i].remove();
                            }
                        }
                        
                        // Auto-scroll to bottom
                        feedElement.scrollTop = feedElement.scrollHeight;
                    }
                }
            }
        }
        
        // Add custom CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slide-in-from-bottom {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .animate-in {
                animation-fill-mode: both;
            }
            
            .slide-in-from-bottom-2 {
                animation-name: slide-in-from-bottom;
            }
            
            .duration-300 {
                animation-duration: 300ms;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>