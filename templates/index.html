<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Real-time Messaging</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/ws.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen" x-data="chatApp()">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-primary-500 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.959 8.959 0 01-4.906-1.681L3 21l2.681-5.094A8.959 8.959 0 013 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-semibold text-gray-900">Chat</h1>
                    <a href="/data-stream" class="ml-4 px-3 py-1 text-sm bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-lg transition-colors">
                        Data Stream Demo
                    </a>
                </div>
                
                <!-- Connection Status -->
                <div class="flex items-center space-x-2">
                    <div class="flex items-center space-x-2" 
                         :class="isConnected ? 'text-green-600' : 'text-red-600'">
                        <div class="w-2 h-2 rounded-full" 
                             :class="isConnected ? 'bg-green-500' : 'bg-red-500'"
                             x-show="!isConnecting"
                             x-transition></div>
                        <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse" 
                             x-show="isConnecting"
                             x-transition></div>
                        <span class="text-sm font-medium" x-text="connectionStatus"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Chat Container -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            
            <!-- Messages Area -->
            <div class="h-96 overflow-y-auto p-3 bg-gray-50" id="messages">
                <!-- Welcome message -->
                <div class="flex justify-center" x-show="messages.length === 0" x-transition>
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="17 8h1a4 4 0 010 8h-1m-10-8H6a4 4 0 000 8h1m4-4h4"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Welcome to Chat</h3>
                        <p class="text-gray-500 max-w-sm">Start a conversation by typing a message below. Open multiple tabs to see real-time messaging in action.</p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-200 bg-white p-4">
                <!-- User Name Input -->
                <div class="mb-3" x-show="!username" x-transition>
                    <label class="block text-sm font-medium text-gray-700 mb-2">What's your name?</label>
                    <div class="flex space-x-3">
                        <input type="text" 
                               x-model="tempUsername"
                               @keydown.enter="setUsername()"
                               placeholder="Enter your name"
                               class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors">
                        <button @click="setUsername()" 
                                :disabled="!tempUsername.trim()"
                                class="px-4 py-2 bg-primary-500 text-white rounded-lg hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            Continue
                        </button>
                    </div>
                </div>

                <!-- Message Input -->
                <div x-show="username" x-transition>
                    <div class="flex items-center space-x-2 mb-3">
                        <div class="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center">
                            <span class="text-xs font-medium text-primary-700" x-text="username.charAt(0).toUpperCase()"></span>
                        </div>
                        <span class="text-sm text-gray-600" x-text="username"></span>
                    </div>
                    
                    <div class="flex items-start space-x-3">
                        <textarea x-model="currentMessage"
                                @keydown.enter.prevent="sendMessage()"
                                @input="autoResize($event)"
                                placeholder="Type your message..."
                                rows="1"
                                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none transition-colors h-12"></textarea>
                        <button @click="sendMessage()" 
                                :disabled="!currentMessage.trim() || !isConnected"
                                class="w-12 h-12 bg-primary-500 text-white rounded-lg hover:bg-primary-600 disabled:opacity-50 disabled:cursor-not-allowed transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions Card -->
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4" x-show="!username" x-transition>
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <svg class="w-5 h-5 text-blue-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-blue-800 mb-1">How it works</h3>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• Enter your name to start chatting</li>
                        <li>• Messages appear instantly for all connected users</li>
                        <li>• Open multiple browser tabs to test real-time messaging</li>
                        <li>• Press Enter to send messages quickly</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <script>
        function chatApp() {
            return {
                socket: null,
                isConnected: false,
                isConnecting: false,
                username: '',
                tempUsername: '',
                currentMessage: '',
                messages: [],
                
                get connectionStatus() {
                    if (this.isConnecting) return 'Connecting...';
                    return this.isConnected ? 'Connected' : 'Disconnected';
                },
                
                init() {
                    console.log('Chat application initialized');
                    this.initWebSocket();
                },
                
                initWebSocket() {
                    this.isConnecting = true;
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${window.location.host}/ws`;
                    console.log('Connecting to WebSocket:', wsUrl);
                    
                    this.socket = new WebSocket(wsUrl);
                    
                    this.socket.onopen = (event) => {
                        console.log('WebSocket connected:', event);
                        this.isConnected = true;
                        this.isConnecting = false;
                    };
                    
                    this.socket.onclose = (event) => {
                        console.log('WebSocket disconnected:', event);
                        this.isConnected = false;
                        this.isConnecting = false;
                        
                        // Attempt to reconnect after 3 seconds
                        setTimeout(() => this.initWebSocket(), 3000);
                    };
                    
                    this.socket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.isConnecting = false;
                    };
                    
                    this.socket.onmessage = (event) => {
                        console.log('Message received:', event.data);
                        this.addMessageToUI(event.data);
                    };
                },
                
                setUsername() {
                    if (this.tempUsername.trim()) {
                        this.username = this.tempUsername.trim();
                        this.tempUsername = '';
                    }
                },
                
                sendMessage() {
                    const message = this.currentMessage.trim();
                    
                    if (message && this.socket && this.socket.readyState === WebSocket.OPEN && this.username) {
                        const data = JSON.stringify({
                            user: this.username,
                            message: message
                        });
                        console.log('Sending data:', data);
                        this.socket.send(data);
                        this.currentMessage = '';
                    }
                },
                
                addMessageToUI(textContent) {
                    const messagesDiv = document.getElementById('messages');
                    
                    // Parse the plain text message
                    const { username, message } = this.parseMessage(textContent);
                    const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    // Check if this is from the same user as the last message
                    const lastMessage = messagesDiv.lastElementChild;
                    const isConsecutive = lastMessage && 
                        lastMessage.dataset.username === username && 
                        this.isRecentMessage(lastMessage.dataset.timestamp);
                    
                    // Create new message element
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message-item animate-in slide-in-from-bottom-2 duration-300';
                    messageElement.dataset.username = username;
                    messageElement.dataset.timestamp = Date.now();
                    
                    if (isConsecutive) {
                        // Compact message without avatar and name
                        messageElement.innerHTML = `
                            <div class="flex hover:bg-gray-50 group transition-colors py-0.5 px-2 -mx-2 rounded ml-11">
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm text-gray-900 leading-relaxed">${message}</div>
                                </div>
                                <div class="opacity-0 group-hover:opacity-100 text-xs text-gray-400 ml-2 transition-opacity">
                                    ${timestamp}
                                </div>
                            </div>
                        `;
                    } else {
                        // Full message with avatar and name
                        messageElement.innerHTML = `
                            <div class="flex hover:bg-gray-50 group transition-colors py-2 px-2 -mx-2 rounded ${messagesDiv.children.length > 0 ? 'mt-3' : ''}">
                                <div class="flex-shrink-0 mr-3">
                                    <div class="w-8 h-8 bg-gradient-to-br from-primary-400 to-primary-600 rounded-lg flex items-center justify-center">
                                        <span class="text-xs font-medium text-white">${username.charAt(0).toUpperCase()}</span>
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-baseline space-x-2 mb-1">
                                        <span class="text-sm font-semibold text-gray-900">${username}</span>
                                        <span class="text-xs text-gray-500">${timestamp}</span>
                                    </div>
                                    <div class="text-sm text-gray-900 leading-relaxed">${message}</div>
                                </div>
                            </div>
                        `;
                    }
                    
                    messagesDiv.appendChild(messageElement);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    
                    // Add to messages array for tracking
                    this.messages.push(textContent);
                },
                
                parseMessage(messageContent) {
                    // Try to match the pattern "username: message"
                    const match = messageContent.match(/^([^:]+):\s*(.+)$/);
                    if (match) {
                        const username = match[1].trim();
                        const message = match[2].trim();
                        return { username, message };
                    }
                    
                    // Fallback: if no colon found, treat entire content as message with anonymous user
                    return { username: 'Anonymous', message: messageContent.trim() };
                },
                
                isRecentMessage(timestamp) {
                    // Consider messages within 2 minutes as consecutive
                    return timestamp && (Date.now() - parseInt(timestamp)) < 120000;
                },
                
                getInitials(messageContent) {
                    // Extract username from message content
                    const match = messageContent.match(/^([^:]+):/);
                    if (match) {
                        const name = match[1].trim();
                        return name.charAt(0).toUpperCase();
                    }
                    return 'U';
                },
                
                autoResize(event) {
                    const textarea = event.target;
                    textarea.style.height = '48px'; // Reset to base height
                    const newHeight = Math.min(Math.max(textarea.scrollHeight, 48), 120);
                    textarea.style.height = newHeight + 'px';
                }
            }
        }
        
        // Add custom CSS for animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slide-in-from-bottom {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .animate-in {
                animation-fill-mode: both;
            }
            
            .slide-in-from-bottom-2 {
                animation-name: slide-in-from-bottom;
            }
            
            .duration-300 {
                animation-duration: 300ms;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>